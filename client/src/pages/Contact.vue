<template>
    <article class="mt-14">
        <header
            class="bg-slate-900 h-44 flex items-center justify-center sm:h-56 md:h-72"
        >
            <h1
                class="text-yellow-200 flex flex-col gap-4 items-center sm:gap-5 md:gap-6"
            >
                <i class="fas fa-envelope text-4xl sm:text-5xl md:text-6xl"></i>
                <span
                    class="text-3xl sm:text-4xl md:text-5xl text-white text-center"
                    >Contact</span
                >
            </h1>
        </header>

        <!-- CONTAINER -->
        <div
            class="container mx-auto sm:py-5 md:py-6 lg:py-8 xl:py-9 grid grid-cols-1 gap-4"
        >
            <div class="py-4 px-4 md:px-12 md:mx-auto">
                <h2 class="text-2xl font-bold my-4">Contactez-nous</h2>
                <h3 class="text-md pt-2 py-4 font-bold">
                    <i class="fas fa-bell text-sky-500"></i> - Avant de Remplir
                    le Formulaire
                </h3>
                <p class="md:w-[80%] mx-auto">
                    <small>
                        Veuillez noter qu'une fois le formulaire rempli, un
                        email pr√©rempli s'ouvrira dans votre logiciel de
                        messagerie par d√©faut. Vous aurez l'opportunit√© de
                        relire et de modifier cet email avant de l'envoyer.
                        Aucun envoi automatique n'est effectu√©.
                    </small>
                </p>
            </div>

            <!-- FORMULAIRE -->
            <section class="py-2 px-1 w-full md:px-6 mx-auto lg:px-12">
                <form
                    @submit="mySubmit"
                    class="grid grid-cols-1 gap-12 mt-4 lg:mt-0 p-4 md:grid-cols-2"
                >
                    <div
                        class="border py-8 px-4 bg-slate-50 h-fit relative rounded shadow-md flex flex-col gap-4 md:col-span-2 lg:row-span-2 lg:col-span-1"
                    >
                        <h4
                            class="absolute top-[-1.3rem] bg-slate-50 mx-8 py-2 px-4 uppercase"
                        >
                            Identit√©e
                        </h4>

                        <!-- NOM -->
                        <div class="form-group flex flex-col">
                            <label
                                for="lastname"
                                class="flex justify-between mb-1"
                            >
                                <span class="font-bold">Nom :</span>
                                <span>{{ counterLastname }}/25</span>
                            </label>
                            <input
                                type="text"
                                id="lastname"
                                name="lastname"
                                placeholder="Votre nom de famille"
                                v-model="lastname.value"
                                @blur="lastname.handleChange"
                                @focus="lastname.handleBlur"
                                :class="{
                                    inputSuccess:
                                        lastname.meta.touched &&
                                        lastname.meta.valid,
                                    inputError:
                                        lastname.meta.touched &&
                                        !lastname.meta.valid,
                                }"
                                autocomplete="family-name"
                                class="placeholder:text-gray-400 rounded"
                            />
                            <Transition appear>
                                <p
                                    v-if="lastname.errorMessage"
                                    class="text-red-500"
                                >
                                    <small>
                                        <em>
                                            {{ lastname.errorMessage }}
                                        </em>
                                    </small>
                                </p>
                            </Transition>
                        </div>

                        <!-- PRENOM -->
                        <div class="form-group flex flex-col">
                            <label
                                for="firstname"
                                class="flex justify-between mb-1"
                            >
                                <span class="font-bold">Pr√©nom :</span>
                                <span>{{ counterFirstname }}/25</span>
                            </label>
                            <input
                                type="text"
                                id="firstname"
                                name="firstname"
                                placeholder="Votre pr√©nom"
                                v-model="firstname.value"
                                @blur="firstname.handleChange"
                                @focus="firstname.handleBlur"
                                :class="{
                                    inputSuccess:
                                        firstname.meta.touched &&
                                        firstname.meta.valid,
                                    inputError:
                                        firstname.meta.touched &&
                                        !firstname.meta.valid,
                                }"
                                autocomplete="given-name"
                            />
                            <Transition appear>
                                <p
                                    v-if="firstname.errorMessage"
                                    class="text-red-500"
                                >
                                    <small
                                        ><em>
                                            {{ firstname.errorMessage }}
                                        </em></small
                                    >
                                </p>
                            </Transition>
                        </div>

                        <!-- EMAIL -->
                        <div class="form-group flex flex-col">
                            <label
                                for="email"
                                class="flex justify-between mb-1"
                            >
                                <span class="font-bold">Email :</span>
                            </label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                placeholder="Votre E-mail"
                                v-model="email.value"
                                @blur="email.handleChange"
                                @focus="email.handleBlur"
                                :class="{
                                    inputSuccess:
                                        email.meta.touched && email.meta.valid,
                                    inputError:
                                        email.meta.touched && !email.meta.valid,
                                }"
                                autocomplete="email"
                            />
                            <Transition appear>
                                <p
                                    v-if="email.errorMessage"
                                    class="text-red-500"
                                >
                                    <small
                                        ><em>
                                            {{ email.errorMessage }}
                                        </em></small
                                    >
                                </p>
                            </Transition>
                        </div>

                        <!-- PHONE -->
                        <div class="form-group flex flex-col">
                            <label
                                for="telephone"
                                class="flex justify-between mb-1"
                            >
                                <span class="font-bold">T√©l√©phone :</span>
                            </label>
                            <input
                                type="tel"
                                id="telephone"
                                name="telephone"
                                placeholder="votre t√©l√©phone"
                                v-model="phone.value"
                                @blur="phone.handleChange"
                                @focus="phone.handleBlur"
                                :class="{
                                    inputSuccess:
                                        phone.meta.touched && phone.meta.valid,
                                    inputError:
                                        phone.meta.touched && !phone.meta.valid,
                                }"
                                autocomplete="tel"
                            />
                            <Transition appear>
                                <p v-if="phone.errorMessage">
                                    <small>
                                        <em class="text-red-500">
                                            {{ phone.errorMessage }}
                                        </em>
                                    </small>
                                </p>
                            </Transition>
                            <Transition appear>
                                <p
                                    v-if="phone.errorMessage"
                                    class="border p-2 mt-2 bg-gray-200 rounded"
                                >
                                    <small>
                                        <span class="text-gray-600"
                                            >Seuls les num√©ros de t√©l√©phone
                                            commen√ßant par 00331, +331, 01,
                                            00334, +334, 04, 00336, +336, 06 ou
                                            00337, +337 ou 07 sont
                                            autoris√©s.</span
                                        ><span class="text-red-500">
                                            Enfin ne sont pas autoris√©s les
                                            points, espaces ou tirets.</span
                                        >
                                    </small>
                                </p>
                            </Transition>
                        </div>
                    </div>

                    <div
                        class="border py-8 px-4 bg-slate-50 h-fit relative rounded shadow-md flex flex-col gap-4"
                    >
                        <h4
                            class="absolute top-[-1.3rem] bg-slate-50 mx-8 py-2 px-4 uppercase"
                        >
                            Localisation
                        </h4>

                        <!-- DEPARTMENT -->
                        <div class="form-group flex flex-col">
                            <label
                                for="departement"
                                class="flex justify-between mb-1 font-bold"
                            >
                                D√©partement:
                            </label>
                            <select
                                name="departement"
                                id="departement"
                                v-model="department.value"
                                @blur="department.handleChange"
                                @focus="department.handleBlur"
                                :class="{
                                    inputSuccess:
                                        department.meta.touched &&
                                        department.meta.valid,
                                    inputError:
                                        department.meta.touched &&
                                        !department.meta.valid,
                                }"
                                autocomplete="address-level1"
                            >
                                <optgroup label="Choisissez un d√©partement">
                                    <option value="ain">Ain</option>
                                    <option value="isere">Is√®re</option>
                                    <option value="Rh√¥ne">Rh√¥ne</option>
                                </optgroup>
                            </select>
                            <Transition appear>
                                <p
                                    v-if="department.errorMessage"
                                    class="text-red-500"
                                >
                                    <small>
                                        <em>
                                            {{ department.errorMessage }}
                                        </em>
                                    </small>
                                </p>
                            </Transition>
                        </div>

                        <!-- CITY -->
                        <div class="form-group flex flex-col">
                            <label
                                for="ville"
                                class="flex justify-between mb-1"
                            >
                                <span font-bold>Ville :</span>
                                <span>{{ counterCity }}/35</span>
                            </label>
                            <input
                                type="text"
                                id="ville"
                                name="ville"
                                placeholder="Pr√©cisez ici la ville"
                                v-model="city.value"
                                @blur="city.handleChange"
                                @focus="city.handleBlur"
                                :class="{
                                    inputSuccess:
                                        city.meta.touched && city.meta.valid,
                                    inputError:
                                        city.meta.touched && !city.meta.valid,
                                }"
                                autocomplete="address-level2"
                            />
                            <Transition appear>
                                <p
                                    v-if="city.errorMessage"
                                    class="text-red-500"
                                >
                                    <small>
                                        <em>
                                            {{ city.errorMessage }}
                                        </em>
                                    </small>
                                </p>
                            </Transition>
                        </div>
                    </div>

                    <div
                        class="border py-8 px-4 bg-slate-50 h-fit relative rounded shadow-md flex flex-col gap-4"
                    >
                        <h4
                            class="absolute top-[-1.3rem] bg-slate-50 mx-8 py-2 px-4 uppercase"
                        >
                            Raison
                        </h4>
                        <!-- SUBJECT / OBJECT / REASON -->
                        <div class="form-group flex flex-col">
                            <label
                                for="choice"
                                class="flex justify-between mb-1"
                            >
                                <span class="font-bold">Objet :</span>
                            </label>

                            <select
                                name="subject"
                                id="choice"
                                v-model="choice.value"
                                @blur="choice.handleChange"
                                @change="choice.handleBlur"
                                :class="{
                                    inputSuccess:
                                        choice.meta.touched &&
                                        choice.meta.valid,
                                    inputError:
                                        choice.meta.touched &&
                                        !choice.meta.valid,
                                }"
                            >
                                <optgroup label="Service">
                                    <option
                                        value="JV-EPAVISTE - J'ai une √©pave √† d√©barrasser"
                                    >
                                        J'ai une √©pave √† d√©barrasser
                                    </option>
                                    <option
                                        value="JV-EPAVISTE - J'ai de la ferraille √† √©vacuer"
                                    >
                                        J'ai de la ferraille √† √©vacuer
                                    </option>
                                    <option
                                        value="JV-EPAVISTE - J'ai des m√©taux √† vendre"
                                    >
                                        J'ai des m√©taux √† vendre
                                    </option>
                                </optgroup>
                            </select>
                            <Transition appear>
                                <p
                                    v-if="choice.errorMessage"
                                    class="text-red-500"
                                >
                                    <small>
                                        <em>
                                            {{ choice.errorMessage }}
                                        </em>
                                    </small>
                                </p>
                            </Transition>
                        </div>

                        <!-- DESCRIBE -->
                        <div class="form-group flex flex-col">
                            <label
                                for="describe"
                                class="flex justify-between mb-1 font-bold"
                            >
                                <span>Description :</span>
                                <span>{{ counterDescribe }}/250</span>
                            </label>
                            <textarea
                                id="describe"
                                name="describe"
                                rows="4"
                                placeholder="veuillez saisir une description de votre demande."
                                v-model="describe.value as string"
                                @blur="describe.handleChange"
                                @focus="describe.handleBlur"
                                :class="{
                                    inputSuccess:
                                        describe.meta.touched &&
                                        describe.meta.valid,
                                    inputError:
                                        describe.meta.touched &&
                                        !describe.meta.valid,
                                }"
                            ></textarea>
                            <Transition appear>
                                <p
                                    v-if="describe.errorMessage"
                                    class="text-red-500"
                                >
                                    <small>
                                        <em>
                                            {{ describe.errorMessage }}
                                        </em>
                                    </small>
                                </p>
                            </Transition>
                        </div>
                    </div>

                    <!-- BUTTON -->
                    <div class="form-group flex md:col-span-2 flex-col">
                        <input
                            type="submit"
                            :disabled="isSubmitting"
                            value="Envoyez"
                            class="border mx-auto rounded py-2 px-8 bg-yellow-400 shadow-md font-bold uppercase cursor-pointer disabled:cursor-not-allowed disabled:bg-gray-500"
                        />
                    </div>
                </form>
            </section>
            <!-- FIN FORMULAIRE -->

            <!-- POURQUOI ? -->
            <section
                id="information"
                class="pt-2 pb-12 px-4 w-full md:px-8 mx-auto lg:px-16"
            >
                <h2 class="text-2xl font-bold my-4 sm:my-6 md:my-8 lg:my-12">
                    <i class="fa-solid fa-question text-sky-500"></i> - Pourquoi
                    Faire Appel √† mes Services ?
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 *:w-full gap-4">
                    <p>
                        üïñ <strong>Disponibilit√© √âtendue :</strong>Nous sommes √†
                        votre service 7 jours sur 7, de 7h √† 20h. Notre grande
                        flexibilit√© horaire vous permet de nous contacter √†
                        votre convenance, que ce soit t√¥t le matin ou en soir√©e.
                    </p>
                    <p>
                        üöö
                        <strong>Interventions Rapides et Efficaces :</strong>
                        Notre √©quipe est pr√™te √† intervenir rapidement pour
                        r√©pondre √† tous vos besoins en mati√®re de r√©cup√©ration
                        de ferraille et d'enl√®vement d'√©paves. Nous comprenons
                        l'importance de traiter ces demandes dans les plus brefs
                        d√©lais.
                    </p>
                    <p>
                        üåç <strong>Respect de l'Environnement :</strong> En tant
                        que ferrailleur √©paviste professionnel, nous nous
                        engageons √† respecter l'environnement dans toutes nos
                        op√©rations. Le recyclage des m√©taux et l'√©limination
                        s√ªre des √©paves sont au c≈ìur de nos pr√©occupations.
                    </p>
                    <p>
                        ü§ù <strong>Service Client D√©di√© :</strong> Nous
                        accordons une importance particuli√®re √† la satisfaction
                        de nos clients. Notre √©quipe est toujours disponible
                        pour r√©pondre √† vos questions et vous fournir des
                        conseils personnalis√©s.
                    </p>
                    <p>
                        üîç <strong>Transparence et Fiabilit√© :</strong> Avec
                        nous, vous b√©n√©ficiez d'un service transparent et
                        fiable. Nous vous fournissons toutes les informations
                        n√©cessaires et nous engageons √† respecter nos accords.
                    </p>
                </div>
            </section>
            <!-- FIN POURQUOI ? -->
        </div>
        <!-- FIN CONTAINER -->

        <!-- IMAGE -->
        <div
            class="h-64 bg-[url('@/assets/images/contact.webp')] lg:h-80 lg:bg-center bg-no-repeat bg-right bg-cover"
        ></div>
    </article>
</template>

<script setup lang="ts">
import { computed, reactive } from 'vue';
import { z } from 'zod';
import { useField, useForm } from 'vee-validate';
import { toTypedSchema } from '@vee-validate/zod';

const phoneRegex = /^((00|\+)?33[1467]|[01][01467])(\d{2}\d{2}\d{2}\d{2})$/;

const myValidationSchema = z.object({
    lastname: z
        .string({ required_error: 'Le nom de famille est obligatoire.' })
        .min(3, {
            message: 'Le nom de famille doit comporter au moins 3 caract√®res.',
        })
        .max(25, {
            message: 'Le nom de famille ne peut pas d√©passer 25 caract√®res.',
        }),

    firstname: z
        .string({ required_error: 'Le pr√©nom est obligatoire.' })
        .min(3, { message: 'Le pr√©nom doit comporter au moins 3 caract√®res.' })
        .max(25, { message: 'Le pr√©nom ne peut pas d√©passer 25 caract√®res.' }),

    email: z
        .string({ required_error: "L'adresse e-mail est obligatoire." })
        .email({ message: "L'adresse e-mail n'est pas valide." }),

    phone: z
        .string({ required_error: 'Le num√©ro de t√©l√©phone est obligatoire.' })
        .regex(phoneRegex, 'Le format du num√©ro de t√©l√©phone est invalide.'),

    department: z.string({
        required_error: "La s√©lection d'un d√©partement est obligatoire.",
    }),

    city: z
        .string({ required_error: 'Le nom de la ville est obligatoire.' })
        .min(5, {
            message: 'Le nom de la ville doit comporter au moins 5 caract√®res.',
        })
        .max(35, {
            message: 'Le nom de la ville ne peut pas d√©passer 35 caract√®res.',
        }),

    choice: z.string({
        required_error: "Le choix d'une raison de contact est obligatoire.",
    }),

    describe: z
        .string({
            required_error: 'Une description de votre demande est n√©cessaire.',
        })
        .min(25, {
            message: 'La description doit comporter au moins 25 caract√®res.',
        })
        .max(250, {
            message: 'La description ne peut pas d√©passer 250 caract√®res.',
        }),
});

const { handleSubmit, isSubmitting } = useForm({
    validationSchema: toTypedSchema(myValidationSchema),
});

interface MAIL {
    lastname: string;
    firstname: string;
    email: string;
    phone: string;
    department: string;
    city: string;
    choice: string;
    describe: string;
}

function createMailtoLink(values: MAIL) {
    const to = 'auto69120@gmail.com'; // Adresse email du destinataire
    const subject = encodeURIComponent(values.choice);
    const body = createEmailBody(values);

    return `mailto:${to}?subject=${subject}&body=${body}`;
}

function createEmailBody(values: MAIL) {
    const message = `
Bonjour M. VIGOUREUX J√©r√¥me,

Je me permets de vous contacter pour solliciter vos services concernant une demande sp√©cifique.
Vous trouverez ci-dessous les d√©tails relatifs √† ma requ√™te :

Nom: ${values.lastname.toUpperCase()}
Pr√©nom: ${values.firstname.charAt(0).toUpperCase() + values.firstname.slice(1)}
D√©partement: ${values.department}
Ville: ${values.city}
Email: ${values.email}
T√©l√©phone: ${values.phone}

Description de la demande :
Bonjour, ${values.describe}

Je suis disponible pour un appel ou un rendez-vous afin de discuter plus en d√©tail de ma demande et de la mani√®re dont vous pourriez m'aider.
Je vous remercie par avance pour l'attention que vous porterez √† ma demande et reste dans l'attente de votre retour.

Cordialement,
${
    values.firstname.charAt(0).toUpperCase() + values.firstname.slice(1)
} ${values.lastname.toUpperCase()}
`;
    return encodeURIComponent(message);
}

const mySubmit = handleSubmit(
    async (values, actions) => {
        console.log(values);
        console.log(actions);

        // G√©n√©rer le lien mailto
        const mailtoLink = createMailtoLink(values);

        // Ouvrir le lien mailto
        window.location.href = mailtoLink;

        // R√©initialisation du formulaire apr√®s l'envoi
        actions.resetForm();
    },
    ({ values, errors, results }) => {
        console.log({ values, errors, results });
    },
);

/**
 * =============================================================================================
 * FIELDS
 * =============================================================================================
 */
const lastname = reactive(
    useField('lastname', undefined, { validateOnValueUpdate: true }),
);
const firstname = reactive(
    useField('firstname', undefined, { validateOnValueUpdate: true }),
);
const email = reactive(
    useField('email', undefined, { validateOnValueUpdate: true }),
);
const phone = reactive(
    useField('phone', undefined, { validateOnValueUpdate: true }),
);
const department = reactive(
    useField('department', undefined, { validateOnValueUpdate: true }),
);
const city = reactive(
    useField('city', undefined, { validateOnValueUpdate: true }),
);
const choice = reactive(
    useField('choice', undefined, { validateOnValueUpdate: true }),
);
const describe = reactive(
    useField('describe', undefined, { validateOnValueUpdate: true }),
);

/**
 * =============================================================================================
 * COUNTERS
 * =============================================================================================
 */
const counterLastname = computed(() =>
    lastname.value ? (lastname.value as string).length : 0,
);
const counterFirstname = computed(() =>
    firstname.value ? (firstname.value as string).length : 0,
);
const counterCity = computed(() => {
    return city.value ? (city.value as string).length : 0;
});
const counterDescribe = computed(() => {
    return describe.value ? (describe.value as string).length : 0;
});

/**
 * =============================================================================================
 * CHECK SUBBMITING
 * =============================================================================================
 */
console.log({
    meta: {
        lastname: { ...lastname.meta },
        firstname: { ...firstname.meta },
        email: { ...email.meta },
        phone: { ...phone.meta },
        department: { ...department.meta },
        city: { ...city.meta },
        choice: { ...choice.meta },
        describe: { ...describe.meta },
    },
});
</script>

<style scoped lang="css">
.inputSuccess {
    border: 1px solid;
    --tw-border-opacity: 1;
    border-color: rgb(74 222 128 / var(--tw-border-opacity));
}
.inputError {
    border: 1px solid;
    --tw-border-opacity: 1;
    border-color: rgb(248 113 113 / var(--tw-border-opacity));
}
</style>
